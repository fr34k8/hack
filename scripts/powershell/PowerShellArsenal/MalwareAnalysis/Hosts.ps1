function Get-HostsFile {
<#
.SYNOPSIS

Parses a HOSTS file.

Author: Matthew Graeber (@mattifestation)
License: BSD 3-Clause
Required Dependencies: None
Optional Dependencies: None

.PARAMETER Path

Specifies an alternate HOSTS path. Defaults to
%SystemRoot%\System32\drivers\etc\hosts.

.PARAMETER Show

Opens the HOSTS file in notepad upon completion.

.EXAMPLE

Get-HostsFile

.EXAMPLE

Get-HostsFile -Path .\hosts
#>

    Param (
        [ValidateScript({Test-Path $_})]
        [String]
        $Path = (Join-Path $Env:SystemRoot 'System32\drivers\etc\hosts'),

        [Switch]
        $Show
    )

    $Hosts = Get-Content $Path -ErrorAction Stop

    $CommentLine = '^\s*#'
    $HostLine = '^\s*(?<IPAddress>\S+)\s+(?<Hostname>\S+)(\s*|\s+#(?<Comment>.*))$'

    $TestIP = [Net.IPAddress] '127.0.0.1'
    $LineNum = 0

    for ($i = 0; $i -le $Hosts.Length; $i++) {
        if (!($Hosts[$i] -match $CommentLine) -and ($Hosts[$i] -match $HostLine)) {
            $IpAddress = $Matches['IPAddress']
            $Comment = ''

            if ($Matches['Comment']) {
                $Comment = $Matches['Comment']
            }

            $Result = New-Object PSObject -Property @{
                LineNumber = $LineNum
                IPAddress = $IpAddress
                IsValidIP = [Net.IPAddress]::TryParse($IPAddress, [Ref] $TestIP)
                Hostname = $Matches['Hostname']
                Comment = $Comment.Trim(' ')
            }

            $Result.PSObject.TypeNames.Insert(0, 'Hosts.Entry')

            Write-Output $Result
        }

        $LineNum++
    }

    if ($Show) {
        notepad $Path
    }
}

function New-HostsFileEntry {
<#
.SYNOPSIS

Replace or append an entry to a HOSTS file.

Author: Matthew Graeber (@mattifestation)
License: BSD 3-Clause
Required Dependencies: Get-HostsFile
Optional Dependencies: None

.PARAMETER IPAddress

Specifies the IP address to which the specified hostname will resolve.

.PARAMETER Hostname

Specifies the hostname that should resolve to the specified IP address.

.PARAMETER Comment

Optionally, specify a comment to be added to the HOSTS entry.

.PARAMETER Path

Specifies an alternate HOSTS path. Defaults to
%SystemRoot%\System32\drivers\etc\hosts.

.PARAMETER PassThru

Outputs a parsed HOSTS file upon completion.

.PARAMETER Show

Opens the HOSTS file in notepad upon completion.

.EXAMPLE

New-HostsFileEntry -IPAddress '127.0.0.1' -Hostname 'c2.evil.com'

.EXAMPLE

New-HostsFileEntry -IPAddress '127.0.0.1' -Hostname 'c2.evil.com' -Comment 'Malware C2'
#>

    [CmdletBinding()] Param (
        [Parameter(Mandatory = $True, Position = 0)]
        [Net.IpAddress]
        $IPAddress,

        [Parameter(Mandatory = $True, Position = 1)]
        [ValidateNotNullOrEmpty()]
        [String]
        $Hostname,

        [Parameter(Position = 2)]
        [ValidateNotNull()]
        [String]
        $Comment,

        [ValidateScript({Test-Path $_})]
        [String]
        $Path = (Join-Path $Env:SystemRoot 'System32\drivers\etc\hosts'),

        [Switch]
        $PassThru,

        [Switch]
        $Show
    )

    $HostsRaw = Get-Content $Path
    $Hosts = Get-HostsFile -Path $Path

    $HostEntry = "$IpAddress $Hostname"

    if ($Comment) {
        $HostEntry += " # $Comment"
    }

    $HostEntryReplaced = $False

    for ($i = 0; $i -lt $Hosts.Length; $i++) {
        if ($Hosts[$i].Hostname -eq $Hostname) {
            if ($Hosts[$i].IpAddress -eq $IPAddress) {
                Write-Verbose "Hostname '$Hostname' and IP address '$IPAddress' already exist in $Path."
            } else {
                Write-Verbose "Replacing hostname '$Hostname' in $Path."
                $HostsRaw[$Hosts[$i].LineNumber] = $HostEntry
            }

            $HostEntryReplaced = $True
        }
    }

    if (!$HostEntryReplaced) {
        Write-Verbose "Appending hostname '$Hostname' and IP address '$IPAddress' to $Path."
        $HostsRaw += $HostEntry
    }

    $HostsRaw | Out-File -Encoding ascii -FilePath $Path -ErrorAction Stop

    if ($PassThru) { Get-HostsFile -Path $Path }

    if ($Show) {
        notepad $Path
    }
}

function Remove-HostsFileEntry {
<#
.SYNOPSIS

Remove an entry or series of entries from a HOSTS file.

Author: Matthew Graeber (@mattifestation)
License: BSD 3-Clause
Required Dependencies: Get-HostsFile
Optional Dependencies: None

.PARAMETER IPAddress

Specifies the IP address. If multiple HOSTS entries exist containing
the same IP address, they will all be removed.

.PARAMETER Hostname

Specifies the hostname that should be removed from the HOSTS file.

.PARAMETER Path

Specifies an alternate HOSTS path. Defaults to
%SystemRoot%\System32\drivers\etc\hosts.

.PARAMETER PassThru

Outputs a parsed HOSTS file upon completion.

.PARAMETER Show

Opens the HOSTS file in notepad upon completion.

.EXAMPLE

Remove-HostsFileEntry -IPAddress '127.0.0.1'

.EXAMPLE

Remove-HostsFileEntry -IPAddress 'c2.evil.com'

.EXAMPLE

Get-HostsFile | Remove-HostsFileEntry

Description
-----------
Removes all entries from the HOSTS file.
#>

    Param (
        [Parameter(Mandatory = $True, ParameterSetName = 'IPAddress')]
        [Net.IpAddress]
        $IPAddress,

        [Parameter(Mandatory = $True, ParameterSetName = 'Hostname')]
        [ValidateNotNullOrEmpty()]
        [String]
        $Hostname,

        [ValidateScript({ Test-Path $_ })]
        [String]
        $Path = (Join-Path $Env:SystemRoot 'System32\drivers\etc\hosts'),

        [Switch]
        $PassThru,

        [Switch]
        $Show,

        [Parameter(ParameterSetName = 'PSObjectArray', ValueFromPipeline = $True)]
        [PSObject[]]
        $HostsEntry
    )

    BEGIN {
        $HostsRaw = Get-Content $Path

        if ($IPAddress -or $Hostname) {
            $HostsEntry = Get-HostsFile -Path $Path
        }

        $ExcludedLineNumbers = @()

        $StringBuilder = New-Object Text.StringBuilder
    }

    PROCESS {
        foreach ($Entry in $HostsEntry) {
            if ($Entry.PSObject.TypeNames[0] -eq 'Hosts.Entry') {
                if ($IPAddress) {
                    if ($Entry.IPAddress -eq $IPAddress) {
                        Write-Verbose "Removing line #$($Entry.LineNumber)."
                        $ExcludedLineNumbers += $Entry.LineNumber
                    }
                } elseif ($Hostname) {
                    if ($Entry.Hostname -eq $Hostname) {
                        Write-Verbose "Removing line #$($Entry.LineNumber)."
                        $ExcludedLineNumbers += $Entry.LineNumber
                    }
                } else {
                    Write-Verbose "Removing line #$($Entry.LineNumber)."
                    $ExcludedLineNumbers += $Entry.LineNumber
                }
            }
        }
    }

    END {
        for ($i = 0; $i -lt $HostsRaw.Length; $i++) {
            if (!$ExcludedLineNumbers.Contains($i)) {
                $null = $StringBuilder.AppendLine($HostsRaw[$i])
            }
        }

        $StringBuilder.ToString() | Out-File $Path

        if ($PassThru) { Get-HostsFile -Path $Path }

        if ($Show) {
            notepad $Path
        }
    }
}